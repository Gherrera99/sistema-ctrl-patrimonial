version: "3.8"
services:
  db:
    image: mysql:8.0
    container_name: hospital_mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: hospital_inventarios
    ports: [ "3306:3306" ]
    volumes: [ "dbdata:/var/lib/mysql" ]
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10
  adminer:
    image: adminer:4
    container_name: hospital_adminer
    ports: [ "8080:8080" ]
    depends_on: [ db ]
  api:
    build: ./hospital-inventarios-api
    container_name: hospital_api
    environment:
      - DATABASE_URL=mysql://root:root@db:3306/hospital_inventarios
      - JWT_SECRET=supersecret
      - NODE_ENV=production
      - PORT=8000
      - ALLOW_ORIGIN=http://localhost:8081
      - PDF_HEADER_ENTITY=HOSPITAL DE LA AMISTAD
      - PDF_HEADER_ADDRESS=CALLE 60 SUR S/N COL SAN JOSE TECOH POR ANILLO PERIFERICO SAN JOSE TECOH PONIENTE
      - PDF_LOGO_LEFT=/app/assets/logo_left.png
      - PDF_LOGO_RIGHT=/app/assets/logo_right.png
      - PDF_CONTROL_NAME=C. ABIB ALEXIS VALLEJOS PÃ‰REZ
      - PDF_AUTH_ENTITY=HOSPITAL DE LA AMISTAD
    volumes:
      - share_informatica25:/mnt/share
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8000:8000"
    command: [
      "sh", "-lc",
      "set -e; \
             mkdir -p \"/mnt/share/Sistemas Hospital/sistema-ctrl-patrimonial/uploads/bien\"; \
             rm -rf /app/uploads; \
             ln -s \"/mnt/share/Sistemas Hospital/sistema-ctrl-patrimonial/uploads\" /app/uploads; \
             ls -la /app/uploads; \
             npm start"
    ]     # ðŸ‘ˆðŸ‘ˆðŸ‘ˆ CLAVE
  web:
    build:
      context: ./hospital-inventarios-web
      args:
        - VITE_OWNER_EMAIL=gustavo.herrera  # ðŸ‘ˆ pon aquÃ­ tu email
    container_name: hospital_web
    depends_on: [ api ]
    ports: [ "8081:80" ]
volumes:
  dbdata: {}
  share_informatica25:
    driver: local
    driver_opts:
      type: cifs
      device: "//192.168.1.10/Informatica25"
      o: "username=Administrador,password=S3rv3r_2025*,vers=3.0,iocharset=utf8,noperm,file_mode=0664,dir_mode=0775"
