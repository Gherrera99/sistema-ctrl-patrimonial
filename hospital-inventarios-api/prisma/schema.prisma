// hospital-inventarios-api/prisma/schema.prisma
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  COLABORADOR

  CONTROL_PATRIMONIAL
  AUXILIAR_PATRIMONIAL
  MANTENIMIENTO
  TECNOLOGIAS
}

enum TipoBien {
  ADMINISTRATIVO
  MEDICO
}

enum EstadoBienLogico {
  ACTIVO
  EN_DICTAMEN
  BAJA
}

enum TipoMovimiento {
  CAMBIO_RESPONSABLE
  CAMBIO_UBICACION
  OTRO
}

enum TipoDictamen {
  ADMINISTRATIVO
  INFORMATICA
  OTRO
}

enum EstadoDictamen {
  BORRADOR
  FIRMADO
  CANCELADO
}

enum TipoArchivoBien {
  FACTURA
  COMPROBANTE_ADQUISICION
  DICTAMEN_COMPLEMENTARIO
  OFICIO_BAJA
  FOTO
  OTRO
}

enum TipoPropiedadBien {
  CONTABLE
  PROPIO
  COMODATO
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(COLABORADOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  MovimientoBien MovimientoBien[]

  DictamenBien DictamenBien[]

  ArchivoBien ArchivoBien[]

  InventoryItem InventoryItem[]
}

model EstadoFisico {
  id    Int             @id @default(autoincrement())
  code  String          @unique
  label String
  orden Int             @default(99)
  items InventoryItem[]
}

model Ubicacion {
  id     Int             @id @default(autoincrement())
  code   String          @unique
  nombre String
  orden  Int             @default(99)
  items  InventoryItem[]
}

model ClasificacionBien {
  id     Int             @id @default(autoincrement())
  sigla  String          @unique
  nombre String?
  items  InventoryItem[]
}

model Proveedor {
  id        Int     @id @default(autoincrement())
  nombre    String
  rfc       String? @unique
  telefono  String?
  correo    String?
  direccion String?

  items InventoryItem[]
}

model InventoryItem {
  id                  Int      @id @default(autoincrement())
  no_inventario       String   @unique @db.VarChar(20)
  nombre              String   @db.VarChar(255)
  consecutivo         Int?
  cuenta              String?  @db.VarChar(100)
  otras_observaciones String?
  costo_adquisicion   Decimal? @db.Decimal(12, 2)

  clasificacionId Int?
  clasificacion   ClasificacionBien? @relation(fields: [clasificacionId], references: [id])

  responsable        String    @db.VarChar(255)
  rfc                String    @db.VarChar(25)
  no_factura         String?   @db.VarChar(30)
  fecha_adjudicacion DateTime?
  modelo             String?   @db.VarChar(255)
  marca              String?   @db.VarChar(255)
  no_serie           String?   @db.VarChar(255)
  observaciones      String?
  fecha_entrega      DateTime?

  estadoLogico EstadoBienLogico @default(ACTIVO)
  fotoUrl      String?          @db.VarChar(500)

  movimientos MovimientoBien[]
  dictamenes  DictamenBien[]
  archivos    ArchivoBien[]

  tipo TipoBien @default(ADMINISTRATIVO) @map("tipo_bien")

  // ðŸ‘‡ NUEVO
  tipoPropiedad TipoPropiedadBien @default(PROPIO)

  proveedorId Int?
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])

  estadoId    Int?
  estado      EstadoFisico? @relation(fields: [estadoId], references: [id])
  ubicacionId Int?
  ubicacion   Ubicacion?    @relation(fields: [ubicacionId], references: [id])

  createdById Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User[]

  @@index([no_inventario])
  @@index([responsable])
  @@index([proveedorId]) // ðŸ‘ˆ opcional pero recomendable
}

model AuthorizerGroup {
  id          Int          @id @default(autoincrement())
  code        TipoBien     @unique
  name        String
  authorizers Authorizer[]
}

model Authorizer {
  id        Int             @id @default(autoincrement())
  fullName  String
  title     String
  entity    String
  active    Boolean         @default(true)
  validFrom DateTime        @default(now())
  validTo   DateTime?
  groupId   Int
  group     AuthorizerGroup @relation(fields: [groupId], references: [id])
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model MovimientoBien {
  id     Int           @id @default(autoincrement())
  bienId Int
  bien   InventoryItem @relation(fields: [bienId], references: [id])

  tipo   TipoMovimiento
  motivo String         @db.VarChar(500)

  // Para trazabilidad de cambios de responsable / ubicaciÃ³n
  responsableAntes   String? @db.VarChar(255)
  responsableDespues String? @db.VarChar(255)
  ubicacionAntes     String? @db.VarChar(255)
  ubicacionDespues   String? @db.VarChar(255)

  fecha DateTime @default(now())

  usuarioId Int
  usuario   User @relation(fields: [usuarioId], references: [id])

  createdAt DateTime @default(now())
}

model DictamenBien {
  id     Int           @id @default(autoincrement())
  bienId Int
  bien   InventoryItem @relation(fields: [bienId], references: [id])

  tipo              TipoDictamen
  coordinacion      String?      @db.VarChar(255)
  unidadAdscripcion String?      @db.VarChar(255)
  ubicacionFisica   String?      @db.VarChar(255)
  fecha             DateTime     @default(now())

  // Texto libre del dictamen ("DescripciÃ³n clara y precisa...")
  dictamenTexto String

  estado EstadoDictamen @default(BORRADOR)

  creadoPorId Int
  creadoPor   User @relation(fields: [creadoPorId], references: [id])

  firmadoPor     String? @db.VarChar(255)
  puestoFirmante String? @db.VarChar(255)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ArchivoBien {
  id     Int           @id @default(autoincrement())
  bienId Int
  bien   InventoryItem @relation(fields: [bienId], references: [id])

  tipo     TipoArchivoBien
  nombre   String          @db.VarChar(255)
  filePath String          @db.VarChar(500) // ruta en disco o URL (S3, etc.)

  uploadedAt DateTime @default(now())

  uploadedById Int
  uploadedBy   User @relation(fields: [uploadedById], references: [id])
}
