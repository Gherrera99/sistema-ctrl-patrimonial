//api/prisma/schema.prisma
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  COLABORADOR

  CONTROL_PATRIMONIAL
  AUXILIAR_PATRIMONIAL
  MANTENIMIENTO
  TECNOLOGIAS
}

enum TipoBien {
  ADMINISTRATIVO
  MEDICO
}

enum EstadoBienLogico {
  BORRADOR
  ACTIVO
  EN_DICTAMEN
  BAJA
}

enum TipoMovimiento {
  CAMBIO_RESPONSABLE
  CAMBIO_UBICACION
  OTRO
}

enum TipoDictamen {
  ADMINISTRATIVO
  INFORMATICA
  OTRO
}

enum EstadoDictamen {
  BORRADOR
  FIRMADO
  CANCELADO
}

enum TipoArchivoBien {
  FACTURA
  COMPROBANTE_ADQUISICION
  DICTAMEN_COMPLEMENTARIO
  OFICIO_BAJA
  FOTO
  OTRO
}

enum TipoPropiedadBien {
  CONTABLE
  PROPIO
  COMODATO
}

enum CategoriaBien {
  GENERAL
  INFORMATICA
}

enum CoordinacionDictamen {
  MANTENIMIENTO
  TECNOLOGIAS
}

enum TipoArchivoDictamen {
  FOTO
  PDF
  OTRO
}

enum EstadoResguardo {
  BORRADOR
  ACTIVO
  CANCELADO
}

enum TipoArchivoResguardo {
  RESGUARDO_FIRMADO
  RESGUARDO_CANCELADO
  OTRO
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(COLABORADOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  MovimientoBien MovimientoBien[]
  DictamenBien   DictamenBien[]
  ArchivoBien    ArchivoBien[]
  InventoryItem  InventoryItem[]

  itemsCreados InventoryItem[] @relation("ItemsCreados")

  DictamenArchivo DictamenArchivo[]

  // NUEVO
  resguardosCreados    ResguardoBien[]    @relation("ResguardoCreadoPor")
  resguardoArchivos    ResguardoArchivo[]
  resguardosCancelados ResguardoBien[]    @relation("ResguardoCanceladoPor")
}

model EstadoFisico {
  id    Int             @id @default(autoincrement())
  code  String          @unique
  label String
  orden Int             @default(99)
  items InventoryItem[]
}

model Ubicacion {
  id     Int             @id @default(autoincrement())
  code   String          @unique
  nombre String
  orden  Int             @default(99)
  items  InventoryItem[]

  ResguardoBien ResguardoBien[]
}

model ClasificacionBien {
  id     Int             @id @default(autoincrement())
  sigla  String          @unique
  nombre String?
  items  InventoryItem[]
}

model Proveedor {
  id        Int     @id @default(autoincrement())
  nombre    String
  rfc       String? @unique
  telefono  String?
  correo    String?
  direccion String?

  items InventoryItem[]
}

model InventoryItem {
  id                  Int      @id @default(autoincrement())
  no_inventario       String   @unique @db.VarChar(20)
  nombre              String   @db.VarChar(255)
  consecutivo         Int?
  cuenta              String?  @db.VarChar(100)
  otras_observaciones String?
  costo_adquisicion   Decimal? @db.Decimal(12, 2)

  clasificacionId Int?
  clasificacion   ClasificacionBien? @relation(fields: [clasificacionId], references: [id])

  categoria CategoriaBien @default(GENERAL)

  responsable        String    @db.VarChar(255)
  rfc                String    @db.VarChar(25)
  no_factura         String?   @db.VarChar(30)
  fecha_adjudicacion DateTime?
  modelo             String?   @db.VarChar(255)
  marca              String?   @db.VarChar(255)
  no_serie           String?   @db.VarChar(255)
  observaciones      String?
  fecha_entrega      DateTime?

  estadoLogico EstadoBienLogico @default(ACTIVO)
  fotoUrl      String?          @db.VarChar(500)

  movimientos MovimientoBien[]
  dictamenes  DictamenBien[]
  archivos    ArchivoBien[]

  // NUEVO: historial de resguardos
  resguardos ResguardoBien[]

  tipo TipoBien @default(ADMINISTRATIVO) @map("tipo_bien")

  tipoPropiedad TipoPropiedadBien @default(PROPIO)

  proveedorId Int?
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])

  estadoId    Int?
  estado      EstadoFisico? @relation(fields: [estadoId], references: [id])
  ubicacionId Int?
  ubicacion   Ubicacion?    @relation(fields: [ubicacionId], references: [id])

  createdById Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User?    @relation("ItemsCreados", fields: [createdById], references: [id])
  User        User?    @relation(fields: [userId], references: [id])
  userId      Int?

  @@index([no_inventario])
  @@index([responsable])
  @@index([proveedorId])
}

model ResguardoBien {
  id     Int           @id @default(autoincrement())
  bienId Int
  bien   InventoryItem @relation(fields: [bienId], references: [id])

  estado EstadoResguardo @default(BORRADOR)

  // snapshot del responsable y rfc que se firma en ese resguardo
  responsable String @db.VarChar(255)
  rfc         String @db.VarChar(25)

  // snapshot de ubicaci√≥n (opcional)
  ubicacionId Int?
  ubicacion   Ubicacion? @relation(fields: [ubicacionId], references: [id])

  creadoPorId Int?
  creadoPor   User? @relation("ResguardoCreadoPor", fields: [creadoPorId], references: [id])

  canceladoAt    DateTime?
  canceladoPorId Int?
  canceladoPor   User?     @relation("ResguardoCanceladoPor", fields: [canceladoPorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  archivos ResguardoArchivo[]

  @@index([bienId])
  @@index([estado])
}

model ResguardoArchivo {
  id Int @id @default(autoincrement())

  resguardoId Int
  resguardo   ResguardoBien @relation(fields: [resguardoId], references: [id])

  tipo     TipoArchivoResguardo
  nombre   String               @db.VarChar(255)
  filePath String               @db.VarChar(500)

  uploadedAt DateTime @default(now())

  uploadedById Int
  uploadedBy   User @relation(fields: [uploadedById], references: [id])

  @@index([resguardoId])
}

model AuthorizerGroup {
  id          Int          @id @default(autoincrement())
  code        TipoBien     @unique
  name        String
  authorizers Authorizer[]
}

model Authorizer {
  id        Int             @id @default(autoincrement())
  fullName  String
  title     String
  entity    String
  active    Boolean         @default(true)
  validFrom DateTime        @default(now())
  validTo   DateTime?
  groupId   Int
  group     AuthorizerGroup @relation(fields: [groupId], references: [id])
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model MovimientoBien {
  id     Int           @id @default(autoincrement())
  bienId Int
  bien   InventoryItem @relation(fields: [bienId], references: [id])

  tipo   TipoMovimiento
  motivo String         @db.VarChar(500)

  responsableAntes   String? @db.VarChar(255)
  responsableDespues String? @db.VarChar(255)
  ubicacionAntes     String? @db.VarChar(255)
  ubicacionDespues   String? @db.VarChar(255)

  fecha DateTime @default(now())

  usuarioId Int
  usuario   User @relation(fields: [usuarioId], references: [id])

  createdAt DateTime @default(now())
}

model DictamenBien {
  id     Int           @id @default(autoincrement())
  bienId Int
  bien   InventoryItem @relation(fields: [bienId], references: [id])

  folio String? @unique @db.VarChar(50)

  coordinacionTipo CoordinacionDictamen
  configId         Int?
  config           DictamenConfig?      @relation(fields: [configId], references: [id])

  tipo              TipoDictamen
  unidadAdscripcion String?      @db.VarChar(255)
  ubicacionFisica   String?      @db.VarChar(255)
  fecha             DateTime     @default(now())

  dictamenTexto String

  estado EstadoDictamen @default(BORRADOR)

  creadoPorId Int
  creadoPor   User @relation(fields: [creadoPorId], references: [id])

  firmadoPor     String?   @db.VarChar(255)
  puestoFirmante String?   @db.VarChar(255)
  firmadoAt      DateTime?
  pdfPath        String?   @db.VarChar(500)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  DictamenArchivo DictamenArchivo[]

  @@index([bienId])
  @@index([estado])
}

model DictamenConfig {
  id Int @id @default(autoincrement())

  coordinacion CoordinacionDictamen @unique

  tituloCoordinacion String @db.VarChar(255)

  firmanteNombre String @db.VarChar(255)
  firmantePuesto String @db.VarChar(255)

  firmaPath String? @db.VarChar(500)
  selloPath String? @db.VarChar(500)

  active    Boolean   @default(true)
  validFrom DateTime  @default(now())
  validTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  DictamenBien DictamenBien[]
}

model DictamenArchivo {
  id Int @id @default(autoincrement())

  dictamenId Int
  dictamen   DictamenBien @relation(fields: [dictamenId], references: [id])

  tipo     TipoArchivoDictamen
  nombre   String              @db.VarChar(255)
  filePath String              @db.VarChar(500)

  uploadedAt DateTime @default(now())

  uploadedById Int
  uploadedBy   User @relation(fields: [uploadedById], references: [id])

  @@index([dictamenId])
}

model ArchivoBien {
  id     Int           @id @default(autoincrement())
  bienId Int
  bien   InventoryItem @relation(fields: [bienId], references: [id])

  tipo     TipoArchivoBien
  nombre   String          @db.VarChar(255)
  filePath String          @db.VarChar(500)

  uploadedAt DateTime @default(now())

  uploadedById Int
  uploadedBy   User @relation(fields: [uploadedById], references: [id])
}
